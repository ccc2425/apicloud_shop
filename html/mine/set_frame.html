<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <title>设置</title>
      <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
      <link rel="stylesheet" type="text/css" href="../../css/aui.css"/>
      <link rel="stylesheet" type="text/css" href="../../css/iconfont.css"/>
      <link rel="stylesheet" type="text/css" href="../../css/public.css"/>
      <style>
          html,body{
            background-color: #eee;
          }
          /*头像*/
          .head-img{
            width: 14vw;
            height: 14vw;
            background: #eee;
            margin: 0 auto 10px;
          }
          /*信息*/
          .aui-list-item-input input,.aui-list{
            font-size: 14px;
          }
          .aui-list .aui-list-item-label{
            line-height: 3.2rem;
          }
          /*提示框*/
          .aui-dialog {
              width: 72vw;
              text-align: center;
              position: fixed;
              z-index: 999;
              left: 50%;
              margin-top: 0;
              margin-left: -36vw;
              top: 45%;
              border-radius: 0.3rem;
              opacity: 0;
              background-color: #ffffff;
              -webkit-transform: translate3d(0, 0, 0) scale(1.2);
              transform: translate3d(-50%, 0, 0) scale(1.2);
              -webkit-transition-property: -webkit-transform, opacity;
              transition-property: transform, opacity;
              /* display: none; */
          }
          .aui-dialog-header{
            font-size: 18px;
          }
          .aui-dialog-btn,.aui-dialog-body{
            font-size: 14px;
          }
      </style>
  </head>
  <body>
    <!-- 头像 -->
    <div onclick="getHeaderImg()" class="fs10 text-center padb30 bgcf mb5 padt10">
      <div id="headImg" class="head-img boradius50">
        <!-- <img src="../../image/a6.png" alt=""> -->
      </div>
      点击修改头像
    </div>
    <!-- 信息 -->
    <ul class="aui-list aui-form-list mb5">
        <li class="aui-list-item lh24">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    昵称
                </div>
                <div class="aui-list-item-input">
                    <input class="iptcob ipt_box" type="text" placeholder="">
                </div>
            </div>
        </li>
        <li class="aui-list-item lh24">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    个人签名
                </div>
                <div class="aui-list-item-input">
                    <input class="ipt_box" type="text" placeholder="记录此刻心情！">
                </div>
            </div>
        </li>
        <li class="aui-list-item lh24">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    微信号
                </div>
                <div class="aui-list-item-input">
                    <input class="ipt_box" type="text" placeholder="请填写微信号">
                </div>
            </div>
        </li>
        <li onclick="openSetFrame('changePassword')" class="aui-list-item lh24">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    修改密码
                </div>
                <div class="aui-list-item-input clearfix">
                    <i class="iconfont fr fs14">&#xe615;</i>
                </div>
            </div>
        </li>
        <li onclick="openSetFrame('changePhone')" class="aui-list-item lh24">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    绑定手机号
                </div>
                <div class="aui-list-item-input clearfix">
                    <i class="iconfont fr fs14">&#xe615;</i>
                    <span id="mobile" class="fr cogry mr2v">199****0580</span>
                </div>
            </div>
        </li>
        <li onclick="openSetFrame('changeApply')" class="aui-list-item lh24">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    修改支付密码
                </div>
                <div class="aui-list-item-input clearfix">
                    <i class="iconfont fr fs14">&#xe615;</i>
                </div>
            </div>
        </li>
        <li onclick="openSetFrame('wx')" class="aui-list-item lh24">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    绑定微信
                </div>
                <div class="aui-list-item-input clearfix">
                    <i class="iconfont fr fs14">&#xe615;</i>
                    <span id="wx_id" class="fr cogry mr2v"></span>
                </div>
            </div>
        </li>
    </ul>
    <ul class="aui-list aui-form-list mb5">
        <li onclick="openSetFrame('privacy')" class="aui-list-item lh24">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    隐私设置
                </div>
                <div class="aui-list-item-input clearfix">
                    <i class="iconfont fr fs14">&#xe615;</i>
                </div>
            </div>
        </li>
        <li onclick="clearChache()" class="aui-list-item lh24">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    清除缓存
                </div>
                <div class="aui-list-item-input clearfix">
                    <i class="iconfont fr fs14">&#xe615;</i>
                    <span id="huancun" class="fr cogry mr2v">20M</span>
                </div>
            </div>
        </li>
        <li onclick="openSetFrame('about')" class="aui-list-item lh24">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-label">
                    关于我们
                </div>
                <div class="aui-list-item-input clearfix">
                    <i class="iconfont fr fs14">&#xe615;</i>
                    <span id="app" class="fr cogry mr2v">当前版本2.5.21</span>
                </div>
            </div>
        </li>
    </ul>
    <!-- 退出登录 -->
    <div onclick="outLog()" class="exit text-center lh40 bgcf">退出登录</div>
  </body>
  <script type="text/javascript" src="../../script/api.js"></script>
  <script type="text/javascript" src="../../script/aui-dialog.js" ></script>
  <script type="text/javascript" src="../../script/md5.js"></script>
  <script type="text/javascript" src="../../script/ajax.js"></script>
  <script type="text/javascript">
      var headImg = document.getElementById('headImg');//头像
      var ipt_box = document.getElementsByClassName('ipt_box');//输入框
      var app = document.getElementById('app');//版本号
      var wx_id = document.getElementById('wx_id');//微信号
      var mobile = document.getElementById('mobile');//手机号
      var huancun = document.getElementById('huancun');//缓存
      var wx_status;
      var mobile_status;
      var imgSrc;
      apiready = function(){
        getPersonalInform();//获取个人数据
        //获取缓存
        api.getCacheSize(function(ret) {
            var size = ret.size;
            size = (size/1024)/1024;
            size = Math.floor(size*100)/100;
            huancun.innerText = size + "M";
        });
        //监听获取绑定成功与否
        api.addEventListener({
            name: 'bind_sucess'
        }, function(ret, err){
            if( ret ){
                 window.location.reload()
            }
        });

      };
      //头像
      function getHeaderImg() {
        api.actionSheet({
            title: '选择',
            cancelTitle: '取消',
            buttons: ['拍照', '从相册选择']
        }, function(ret, err) {
            var sourceTypes = [
              "camera",
              "album"
            ];
            api.getPicture({
                sourceType: sourceTypes[ret.buttonIndex-1],
                encodingType: 'jpg',
                mediaValue: 'pic',
                destinationType: 'url',
                allowEdit: true,
                quality: 50,
                saveToPhotoAlbum: false
            }, function(ret, err) {
                imgSrc = ret.data;
                getImg(ret)
            });
        });
      }
      //
      function getImg(_data) {
          api.imageCache({
              url: _data.data
          }, function(ret, err){
              headImg.style.background = 'url(' + ret.url  + ')';
              headImg.style.backgroundSize = '100% 100%';
              headImg.style.backgroundRepeat = "no-repeat";
          });
      }
      //设置页面
      function openSetFrame(type) {
        var mobileVal = mobile.innerText;
        if (type === 'wx') {
          if (wx_id.innerText !== "") {
            api.toast({
                msg: '已绑定微信号',
                duration: 2000,
                location: 'middle'
            });
          }else {
            api.openWin({
                name: 'bindWX',
                url: './seting/bindWX.html',
                pageParam: {
                    name: 'test'
                }
            });
          }
        }else {
          if (mobileVal === "") {
            if (type === "changePhone") {
              api.openWin({
                name: type,
                url: './seting/' + type + '.html',
                pageParam: {
                  mobileVal: mobileVal
                }
              });
            }else {
              api.toast({
                  msg: '请先绑定手机号',
                  duration: 2000,
                  location: 'middle'
              });
            }
          } else {
            api.openWin({
              name: type,
              url: './seting/' + type + '.html',
              pageParam: {
                mobileVal: mobileVal,
                mobile_status:mobile_status
              }
            });
          }
        }
      }
      //清除缓存
      function clearChache() {
        var huancun = document.getElementById('huancun');
        var dialog = new auiDialog();
        dialog.alert({
            title:"清除",
            msg:'清除缓存？',
            buttons:['取消','确定']
        },function(ret){
            if (ret.buttonIndex === 2) {
              api.clearCache(function() {
                  api.toast({
                      msg: '清除完成'
                  });
                  huancun.innerHTML = '0M';
              });
            }
        })
      }
      //退出登录
      function outLog() {
        $api.rmStorage('token');
        api.sendEvent({
            name: 'loginout',
            extra: {
            }
        });

        api.closeToWin({
            name: 'root'
        });
        // api.closeWin();
      }
      //获取个人信息
      var getPersonalInform = function () {
        axios({
          url: '/api/rmuser/getuserinfo',
          data:{
          }
        },function(ret){
          console.log(JSON.stringify(ret));
          if (ret.code === 200) {
            headImg.style.background = 'url(' + ret.data.avatar  + ')';//获取头像
            headImg.style.backgroundSize = '100% 100%';
            headImg.style.backgroundRepeat = "no-repeat";
            imgSrc = ret.data.avatar;
            ipt_box[0].value = ret.data.nickname;//昵称
            console.log(ipt_box.length);
            ipt_box[1].value = ret.data.signature;//签名
            ipt_box[2].value = ret.data.wx_account;//微信号
            wx_id.innerText = ret.data.nickname;//绑定微信
            mobile.innerText = ret.data.mobile;//手机号
            //版本号
            var appVersion = api.appVersion;
            app.innerText = "当前版本"+appVersion;
            if (ret.data.mobile === "") {
              mobile_status = 0
            } else {
              mobile_status = 1
            }
          }
        })
      }
      //上传修改信息
      var upData = function () {
        var nicknameVal = ipt_box[0].value;
        var signatureVal = ipt_box[1].value;
        var wx_accountVal = ipt_box[2].value;
        // alert(imgSrc)
        axios({
          url: '/api/rmuser/edituserinfo',
          data:{
            avatar:imgSrc,
            nickname:nicknameVal,
            signature:signatureVal,
            wx_account:wx_accountVal
          }
        },function(ret){
            console.log(JSON.stringify(ret));
            if (ret.code === 200) {
              api.sendEvent({
                  name: 'updata_sucess',
                  extra: {
                  }
              });

              api.closeWin();
            }
        })
      }
  </script>
  </html>
